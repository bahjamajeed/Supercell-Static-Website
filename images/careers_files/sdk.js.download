"use strict";(()=>{var O=Object.defineProperty,k=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var z=(i,t,e)=>t in i?O(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,h=(i,t)=>{for(var e in t||(t={}))K.call(t,e)&&z(i,e,t[e]);if(b)for(var e of b(t))R.call(t,e)&&z(i,e,t[e]);return i},u=(i,t)=>k(i,D(t));var s=(i,t,e)=>new Promise((o,a)=>{var r=n=>{try{p(e.next(n))}catch(S){a(S)}},d=n=>{try{p(e.throw(n))}catch(S){a(S)}},p=n=>n.done?o(n.value):Promise.resolve(n.value).then(r,d);p((e=e.apply(i,t)).next())});var v={ssoBaseUrl:"https://accounts.supercell.com",debugLogEnabled:!1,accountIdCookieName:"scsso_scid",authorizationCacheLocalStorageKey:"scsso_authorization"};var l=v,m=60*1e3,U=2.5*m,w=5*m,L=10*m,x=25*m,y=200,E=5e3,A=i=>{let t=document.cookie.split(";").find(e=>e.trim().startsWith(i+"="));return t?t.split("=")[1]:null},T=(i,t)=>i+Math.random()*(t-i),C=()=>document.visibilityState==="visible"||document.hasFocus(),c=class i extends Error{constructor(){super("Authorization has been revoked"),Object.setPrototypeOf(this,i.prototype)}},g=class i extends Error{constructor(){super("Authorization has been revoked"),Object.setPrototypeOf(this,i.prototype)}},I=(()=>{var i="scsso_localstorage_test";try{return localStorage.setItem(i,i),localStorage.removeItem(i),!0}catch(t){return!1}})(),f=class{constructor(t){let e=typeof t.debugLogEnabled!="undefined"?t.debugLogEnabled:l.debugLogEnabled;this.options=u(h({},t),{authorizationCacheLocalStorageKey:t.authorizationCacheLocalStorageKey||l.authorizationCacheLocalStorageKey,ssoBaseUrl:t.ssoBaseUrl||l.ssoBaseUrl,accountIdCookieName:t.accountIdCookieName||l.accountIdCookieName,debugLogEnabled:e}),this.state={failedTicks:0,lastLoginTime:0,lastRevalidationTime:0,wasActive:C(),stopped:!1}}start(){this.state.cachedAuthorization=this.loadCachedAuthorization();let t=A(this.options.accountIdCookieName);return this.tick(),{selectedAccountId:t}}stop(){return s(this,null,function*(){this.state.timerId&&clearTimeout(this.state.timerId)})}refresh(){return s(this,null,function*(){return this.state.timerId&&clearTimeout(this.state.timerId),this.state=u(h({},this.state),{timerId:void 0,cachedAuthorization:void 0,failedTicks:0,lastLoginTime:0,lastRevalidationTime:0}),new Promise((t,e)=>s(this,null,function*(){try{yield this.tick(),t()}catch(o){e(o)}}))})}logout(){return s(this,null,function*(){yield fetch(this.options.ssoBaseUrl+"/oauth/sso/logout",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},credentials:"include"}),yield this.options.onLogout(),this.resetState()})}tick(){return s(this,null,function*(){let t=!1;try{let e=this.state.wasActive;if(C())this.state.wasActive=!0,e||this.debugLog("Window is now active again");else{this.state.wasActive=!1,e&&this.debugLog("Window is not active, waiting for it to become active");return}let o=A(this.options.accountIdCookieName),a=this.state.cachedAuthorization;if(a&&(a.timestamp+U<new Date().getTime()||a.accountId!==o)&&(this.debugLog("Clearing stale authorization cache"),this.resetCachedAuthorization()),!o&&this.state.loggedInAccountId){this.debugLog("User-initiated log out detected"),yield this.handleLogout();return}if(o&&this.state.loggedInAccountId&&o!==this.state.loggedInAccountId){this.debugLog("User-initiated account switch detected (from "+this.state.loggedInAccountId+" to "+o+")"),yield this.handleLogin();return}if(o&&!this.state.loggedInAccountId){this.debugLog("SSO login available for "+o),yield this.handleLogin();return}if(this.state.loggedInAccountId){let r=new Date().getTime()-this.state.lastRevalidationTime;this.state.revalidationInterval&&r>=this.state.revalidationInterval&&(yield this.handleRefresh())}}catch(e){throw t=!0,this.resetCachedAuthorization(),e}finally{if(this.state.stopped)return;let e=100;if(t){let o=Math.random(),a=y*2**this.state.failedTicks;e=Math.round(Math.min(E,Math.max(y,a*o))),this.debugLog("Tick failed "+(this.state.failedTicks+1)+" times, retrying in "+e+"ms")}this.state.failedTicks=t?this.state.failedTicks+1:0,this.state.timerId=setTimeout(()=>this.tick(),e)}})}ssoAuthorize(){return s(this,null,function*(){if(this.state.cachedAuthorization)return this.state.cachedAuthorization;let t=new URLSearchParams({client_id:this.options.clientId,scope:this.options.scope}),e=yield fetch(this.options.ssoBaseUrl+"/oauth/sso/authorize",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,credentials:"include"}),o=yield e.json();if(e.ok&&o.ok){let a=o.data,r=new Date().getTime(),d={authorizationCode:a.authorizationCode,accountId:a.scid,timestamp:r,refreshNeeded:a.refreshNeeded};return this.setCachedAuthorization(d),d}else throw e.status===401&&o.error==="unauthorized"?(this.debugLog("/oauth/sso/authorize call failed with 401 Unauthorized response",{status:e.status,body:o}),new c):e.status===403&&o.error==="country_blocked"?(this.debugLog("/oauth/sso/authorize call failed with 403 Forbidden response and country_blocked message",{status:e.status,body:o}),new g):(this.debugLog("/oauth/sso/authorize call failed with unexpected status / body",{status:e.status,body:o}),new Error("/oauth/sso/authorize failed"))})}debugLog(t,e){if(this.options.debugLogEnabled){let o=new Date().toISOString();e?console.log("["+o+"][SSOSDK]: "+t,e):console.log("["+o+"][SSOSDK]: "+t)}}handleLogout(){return s(this,null,function*(){try{this.resetCachedAuthorization(),yield this.options.onLogout(),this.resetState()}catch(t){throw this.debugLog("onLogout() failed",t),t}})}handleLogin(){return s(this,null,function*(){try{let t=yield this.ssoAuthorize();if(t.refreshNeeded&&typeof this.options.onSessionRefreshNeeded!="undefined"){this.resetCachedAuthorization(),this.state.stopped=!0,this.options.onSessionRefreshNeeded();return}yield this.options.onLogin({authorizationCode:t.authorizationCode,accountId:t.accountId}),this.state.loggedInAccountId=t.accountId,this.state.lastLoginTime=new Date().getTime(),this.state.lastRevalidationTime=t.timestamp;let e=this.state.lastLoginTime-t.timestamp;this.state.revalidationInterval=T(w,L)-e,this.debugLog("SSO login successful to "+t.accountId+". Re-validating authorization in "+Math.ceil(this.state.revalidationInterval/1e3)+" seconds (authorization age "+Math.ceil(e/1e3)+" seconds)")}catch(t){if(this.debugLog("SSO login failed",t),t instanceof c||t instanceof g){yield this.handleLogout();return}throw t}})}handleRefresh(){return s(this,null,function*(){let t=new Date().getTime()-this.state.lastLoginTime;try{let e=yield this.ssoAuthorize();t>=x&&(this.debugLog("Login needs to be refreshed"),yield this.options.onLogin({authorizationCode:e.authorizationCode,accountId:e.accountId}),this.state.loggedInAccountId=e.accountId,this.state.lastLoginTime=new Date().getTime()),this.state.lastRevalidationTime=new Date().getTime(),this.state.revalidationInterval=T(w,L),this.debugLog("Authorization re-validation successful. Re-validating authorization in "+Math.ceil(this.state.revalidationInterval/1e3)+" seconds")}catch(e){if(this.debugLog("SSO authorization re-validation failed",e),e instanceof c){yield this.handleLogout();return}throw e}})}loadCachedAuthorization(){if(!I)return;let t=localStorage.getItem(this.options.authorizationCacheLocalStorageKey);if(t){let e=JSON.parse(t);if(!e.timestamp){this.debugLog("Invalid cached authorization");return}return e}}resetCachedAuthorization(){this.state.cachedAuthorization=void 0,I&&localStorage.removeItem(this.options.authorizationCacheLocalStorageKey)}setCachedAuthorization(t){this.state.cachedAuthorization=t,I&&localStorage.setItem(this.options.authorizationCacheLocalStorageKey,JSON.stringify(t))}resetState(){this.state=u(h({},this.state),{loggedInAccountId:void 0,lastLoginTime:0,lastRevalidationTime:0,revalidationInterval:void 0})}};window.SSOSDK=f;})();
